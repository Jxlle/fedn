<!DOCTYPE html>
<html >
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

      <title>Tutorial: Compute Package</title>
    
          <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
          <link rel="stylesheet" href="_static/theme.css " type="text/css" />
          <link rel="stylesheet" href="_static/custom.css" type="text/css" />
      
      <!-- sphinx script_files -->
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>

      
      <!-- bundled in js (rollup iife) -->
      <!-- <script src="_static/theme-vendors.js"></script> -->
      <script src="_static/theme.js" defer></script>
    
  <link rel="index" title="Index" href="genindex.html" />
  <link rel="search" title="Search" href="search.html" />
  <link rel="next" title="Release Notes" href="releasenotes.html" />
  <link rel="prev" title="Deployment" href="deployment.html" /> 
  </head>

  <body>
    <div id="app">
    <div class="theme-container" :class="pageClasses"><navbar @toggle-sidebar="toggleSidebar">
  <router-link to="index.html" class="home-link">
    
      <img class="logo" src="_static/fedn_logo.webp" alt="logo"/>
    
  </router-link>

  <div class="links">
    <navlinks class="can-hide">



    </navlinks>
  </div>
</navbar>

      
      <div class="sidebar-mask" @click="toggleSidebar(false)">
      </div>
        <sidebar @toggle-sidebar="toggleSidebar">
          
          <navlinks>
            



            
          </navlinks><div id="searchbox" class="searchbox" role="search">
  <div class="caption"><span class="caption-text">Quick search</span>
    <div class="searchformwrapper">
      <form class="search" action="search.html" method="get">
        <input type="text" name="q" />
        <input type="submit" value="Search" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div><div class="sidebar-links" role="navigation" aria-label="main navigation">
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="index.html#license">Contents:</a></span>
      </p>
      <ul class="current">
        
          <li class="toctree-l1 ">
            
              <a href="index.html" class="reference internal ">Welcome to FEDn documentation</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="architecture.html" class="reference internal ">Architecture overview</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="deployment.html" class="reference internal ">Deployment</a>
            

            
          </li>

        
          <li class="toctree-l1 current">
            
              <a href="#" class="reference internal current">Tutorial: Compute Package</a>
            

            
              <ul>
                
                  <li class="toctree-l2"><a href="#the-compute-package" class="reference internal">The compute package</a></li>
                
                  <li class="toctree-l2"><a href="#designing-the-compute-package" class="reference internal">Designing the compute package</a></li>
                
                  <li class="toctree-l2"><a href="#more-on-data-access" class="reference internal">More on Data access</a></li>
                
                  <li class="toctree-l2"><a href="#running-the-client" class="reference internal">Running the client</a></li>
                
              </ul>
            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="releasenotes.html" class="reference internal ">Release Notes</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="sdk.html" class="reference internal ">SDK Documentation</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="faq.html" class="reference internal ">Frequently asked questions</a>
            

            
          </li>

        
      </ul>
    </div>
  
</div>
        </sidebar>

      <page>
          <div class="body-header" role="navigation" aria-label="navigation">
  
  <ul class="breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
    
    <li>Tutorial: Compute Package</li>
  </ul>
  

  <ul class="page-nav">
  <li class="prev">
    <a href="deployment.html"
       title="previous chapter">← Deployment</a>
  </li>
  <li class="next">
    <a href="releasenotes.html"
       title="next chapter">Release Notes →</a>
  </li>
</ul>
  
</div>
<hr>
          <div class="content" role="main" v-pre>
            
  <section id="tutorial-compute-package">
<h1>Tutorial: Compute Package<a class="headerlink" href="#tutorial-compute-package" title="Permalink to this headline">¶</a></h1>
<p>This tutorial walks you through the key step done by the <em>model initiator</em> when setting up a federated project.
The code for this guideline has been taken from the mnist-keras example provided <a class="reference external" href="https://github.com/scaleoutsystems/examples">here</a>.
However, some modification to the code has been made for educational purposes.</p>
<section id="the-compute-package">
<h2>The compute package<a class="headerlink" href="#the-compute-package" title="Permalink to this headline">¶</a></h2>
<a class="reference internal image-reference" href="_images/ComputePackageOverview.png"><img alt="Compute package overview" class="align-center" src="_images/ComputePackageOverview.png" style="width: 100%;" /></a>
<p>The <em>compute package</em> is a tar.gz bundle of the code to be executed by each data-provider/client.
This package is uploaded to the Reducer upon initialization of the FEDN Network (along with the initial model).
When a client connects to the network, it downloads and unpacks the package locally and are then ready to
participate in training and/or validation.</p>
<p>The logic is illustrated in the above figure. When the <a class="reference external" href="https://github.com/scaleoutsystems/fedn/blob/master/fedn/fedn/client.py">FEDn client</a>.
recieves a model update request from the combiner, it calls upon a Dispatcher that looks up entry point definitions
in the compute package. These entrypoints define commands executed by the client to update/train or validate a model.</p>
</section>
<section id="designing-the-compute-package">
<h2>Designing the compute package<a class="headerlink" href="#designing-the-compute-package" title="Permalink to this headline">¶</a></h2>
<p>We recommend to use the project structure followed by most example projects <a class="reference external" href="https://github.com/scaleoutsystems/examples">here</a>.
In the examples we have roughly the following structure:</p>
<a class="reference internal image-reference" href="_images/tree_package.png"><img alt="Project structure" class="align-center" src="_images/tree_package.png" style="width: 207.2px; height: 298.9px;" /></a>
<p>The “client” folder is the <em>compute package</em> which will become a tar.gz bundle of the code to be executed by
each data-provider/client. The entry points, mentioned above, are defined in the <em>fedn.yaml</em>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">entry_points</span><span class="p">:</span>
    <span class="nt">train</span><span class="p">:</span>
        <span class="nt">command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">python train.py</span>
    <span class="nt">validate</span><span class="p">:</span>
        <span class="nt">command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">python validate.py</span>
</pre></div>
</div>
<p>Where the training entry point has the following logical overview:</p>
<a class="reference internal image-reference" href="_images/TrainSISO.png"><img alt="Training entrypoint" class="align-center" src="_images/TrainSISO.png" style="width: 100%;" /></a>
<p>The training entry point should be a single-input single-output program, taking as input a model update file
and writing a model update file (same file format). Staging and upload of these files are handled by the FEDn client. A helper class in the FEDn SDK handled the ML-framework
specific file serialization and deserialization. The validation entry point acts very similar except we perform validation on the
<em>model_in</em> and outputs a json containing a validation scores (see more below).</p>
<p>Upon training (model update) requests from the combiner, the client will download the latest (current) global model and <em>train.py</em> will be executed with this model update as input. After training / updating completes, the local client will capture the output file and send back the updated model to the combiner. For the local execution this means that the program (in this case train.py) will be executed as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">train</span><span class="o">.</span><span class="n">py</span> <span class="n">model_in</span> <span class="n">model_out</span>
</pre></div>
</div>
<p>A typical <em>train.py</em> example can look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="kn">from</span> <span class="nn">data.read_data</span> <span class="kn">import</span> <span class="n">read_data</span>


<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">data_path</span><span class="p">,</span><span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Training function which will be called upon model update requests</span>
<span class="sd">    from the combiner</span>

<span class="sd">    :param model: The latest global model, see &#39;__main__&#39;</span>
<span class="sd">    :type model: User defined</span>
<span class="sd">    :param data: Traning data</span>
<span class="sd">    :type data: User defined</span>
<span class="sd">    :param settings: Hyper-parameters settings</span>
<span class="sd">    :type settings: dict</span>
<span class="sd">    :return: Trained/updated model</span>
<span class="sd">    :rtype: User defined</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;-- RUNNING TRAINING --&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1">#CODE TO READ DATA</span>

    <span class="c1">#EXAMPLE, SOME USER DEFINED FUNCION THAT READS THE TRAINING DATA</span>
    <span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">trainset</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1">#CODE FOR START TRAINING</span>
    <span class="c1">#EXAMPLE (Tensoflow)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">],</span> <span class="n">epochs</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;-- TRAINING COMPLETED --&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="c1">#READ HYPER_PARAMETER SETTINGS FROM YAML FILE</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;settings.yaml&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">settings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">fh</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">yaml</span><span class="o">.</span><span class="n">YAMLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="c1">#CREATE THE SEED MODEL AND UPDATE WITH LATEST WEIGHTS</span>
    <span class="c1">#EXAMPLE, USE KERAS HELPER IN FEDN SDK FOR READING WEIGHTS</span>
    <span class="kn">from</span> <span class="nn">fedn.utils.kerashelper</span> <span class="kn">import</span> <span class="n">KerasHelper</span>
    <span class="n">helper</span> <span class="o">=</span> <span class="n">KerasHelper</span><span class="p">()</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1">#EXAMPLE, A USER DEFINED FUNCTION THAT CONSTRUCTS THE MODEL, E.G THE ARCHITECTURE OF A NEURAL NETWORK</span>
    <span class="kn">from</span> <span class="nn">models.model</span> <span class="kn">import</span> <span class="n">create_seed_model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">create_seed_model</span><span class="p">()</span>
    <span class="c1">#EXAMPLE (HOW TO SET WEIGHTS OF A MODEL DIFFERS BETWEEN LIBRARIES)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">set_weights</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

    <span class="c1">#CALL TRAINING FUNCTION AND GET UPDATED MODEL</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="s1">&#39;../data/your_data.file&#39;</span><span class="p">,</span><span class="n">settings</span><span class="p">)</span>

    <span class="c1">#SAVE/SEND MODEL</span>
    <span class="c1">#EXAMPLE, USING KERAS HELPER IN FEDN SDK</span>
    <span class="n">helper</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(),</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
<p>The format of the input and output files (model updates) are dependent on the ML framework used. A <a class="reference external" href="https://github.com/scaleoutsystems/fedn/blob/master/fedn/fedn/utils/kerashelper.py">helper class</a>.
defines serializaion and de-serialization of the model updates.
Observe that the functions <a class="reference external" href="https://github.com/scaleoutsystems/examples/blob/b5876dc42e91b694488351b5dbff0cef3329b7dc/mnist-keras/client/models/mnist_model.py#L13">create_seed_model</a>
and <a class="reference external" href="https://github.com/scaleoutsystems/examples/blob/b5876dc42e91b694488351b5dbff0cef3329b7dc/mnist-keras/client/data/read_data.py#L4">read_data</a> are implemented by the user, where the first function
constructs (compiles) and returns an untrained (seed) model. We then take this model and set the weights to be equal to the current global model recieved
from the commbiner. In the example above we use the Keras helper class to de-serialize those weights and the keras funcion <em>model.set_weights()</em> to set the seed model to be equal to the current model.
We then call the <em>train</em> function to first read the training data
(obs. the location of the data can differ depending on if you run the client in a native or containerized environment, in the latter case it’s recommend to mount the data to the container,
the location should then be relative to the mount path) and then start the training.
In this example, training equals fitting the keras model, thus we call <em>model.fit()</em> fucntion.
The <em>settings.yaml</em> is for conveniance and is not required but contains the hyper-parameter settings for the local training as key/value pairs.</p>
<p>For validations it is a requirement that the output is valid json:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">validate</span><span class="o">.</span><span class="n">py</span> <span class="n">model_in</span> <span class="n">validation</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
<p>The Dahboard in the FEDn UI will plot any scalar metric in this json file, but you can include any type in the file assuming that it is valid json. These values can then be obtained (by an athorized user) from the MongoDB database (via Mongo Express, or any query interface or API). Typically, the actual model is defined in a small library, and does not depend on FEDn. An example (based on the keras case) of the <em>validate.py</em> is povided below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">data.read_data</span> <span class="kn">import</span> <span class="n">read_data</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">metrics</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validation function which will be called upon model validation requests</span>
<span class="sd">    from the combiner.</span>

<span class="sd">    :param model: The latest global model, see &#39;__main__&#39;</span>
<span class="sd">    :type model: User defined</span>
<span class="sd">    :param data: The data used for validation, could include both training and test/validation data</span>
<span class="sd">    :type data: User defined</span>
<span class="sd">    :return: Model scores from the validation</span>
<span class="sd">    :rtype: dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;-- RUNNING VALIDATION --&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1">#CODE TO READ DATA</span>

    <span class="c1">#EXAMPLE</span>
    <span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">trainset</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1">#EXAMPLE</span>
    <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">trainset</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1">#CODE HERE FOR OBTAINING VALIDATION SCORES</span>

        <span class="c1">#EXAMPLE</span>
        <span class="n">model_score</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">model_score_test</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">clf_report</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span><span class="n">y_pred</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;failed to validate the model {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">),</span><span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="c1">#PUT SCORES AS VALUES FOR CORRESPONDING KEYS (CHANGE VARIABLES):</span>
    <span class="n">report</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;classification_report&quot;</span><span class="p">:</span> <span class="n">clf_report</span><span class="p">,</span>
                <span class="s2">&quot;training_loss&quot;</span><span class="p">:</span> <span class="n">model_score</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;training_accuracy&quot;</span><span class="p">:</span> <span class="n">model_score</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s2">&quot;test_loss&quot;</span><span class="p">:</span> <span class="n">model_score_test</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;test_accuracy&quot;</span><span class="p">:</span> <span class="n">model_score_test</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">}</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;-- VALIDATION COMPLETE! --&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">report</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="c1">#READS THE LATEST WEIGHTS FROM GLOBAL MODEL (COMBINER)</span>

    <span class="kn">from</span> <span class="nn">fedn.utils.kerashelper</span> <span class="kn">import</span> <span class="n">KerasHelper</span>
    <span class="n">helper</span> <span class="o">=</span> <span class="n">KerasHelper</span><span class="p">()</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1">#CREATE THE SEED MODEL AND UPDATE WITH LATEST WEIGHTS</span>
    <span class="kn">from</span> <span class="nn">models.model</span> <span class="kn">import</span> <span class="n">create_seed_model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">create_seed_model</span><span class="p">()</span>
    <span class="c1">#EXAMPLE (HOW TO SET WEIGHTS OF A MODEL DIFFERS BETWEEN LIBRARIES)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">set_weights</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

    <span class="c1">#START VALIDATION</span>
    <span class="n">report</span> <span class="o">=</span> <span class="n">validate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="s1">&#39;../data/your_data.file&#39;</span><span class="p">)</span>

    <span class="c1">#SAVE/SEND SCORE REPORT</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">report</span><span class="p">))</span>
</pre></div>
</div>
<p>As demonstrated in the code above, the structure is very similar to <em>train.py</em>. The main difference is that we perform validation of a current model provided by the combiner instead of training. Again, the <em>read_data</em> function is defined by the user. Once, we have optained a validation
<em>report</em> as a dictionary we can dump as json (required). Observe that the key/values are arbitrary.</p>
<p>For the initialization of the Reducer, both the compute package and an initial model (weights) are required as individual files. To obtain the initial weights file we can use the fedn helpers to save the seed model to an output file (<em>init_model.py</em>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fedn.utils.kerashelper</span> <span class="kn">import</span> <span class="n">KerasHelper</span>
<span class="kn">from</span> <span class="nn">models.mnist_model</span> <span class="kn">import</span> <span class="n">create_seed_model</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="c1">#CREATE INITIAL MODEL, UPLOAD TO REDUCER</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">create_seed_model</span><span class="p">()</span>
    <span class="n">outfile_name</span> <span class="o">=</span> <span class="s2">&quot;../initial_model/initial_model.npz&quot;</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>
    <span class="n">helper</span> <span class="o">=</span> <span class="n">KerasHelper</span><span class="p">()</span>
    <span class="n">helper</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">outfile_name</span><span class="p">)</span>
</pre></div>
</div>
<p>Which will be saved into the <em>initial_model</em> folder for convenience. Of course this file can also be a pretrained seed model.
For the compute package we need to compress the <em>client</em> folder as .tar.gz file. E.g. using:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tar -czvf package.tar.gz client
</pre></div>
</div>
</section>
<section id="more-on-data-access">
<h2>More on Data access<a class="headerlink" href="#more-on-data-access" title="Permalink to this headline">¶</a></h2>
<p>There are many possible ways to interact with the local dataset. In principle, the only requirement is that the train and validate endpoints are able to correctly
read and use the data. In practice, it is then necessary to make some assumption on the local environemnt when writing train.py and validate.py. This is best explained
by looking at the code above. Here we assume that the dataset is present in a file called “your_data.file” in a folder “data” one level up in the file hierarchy relative to
the exection of train.py. Then, independent on the preferred way to run the client (native, Docker, K8s etc) this structure needs to be maintained for this particular
compute package. Note however, that there are many ways to accompish this on a local operational level.</p>
</section>
<section id="running-the-client">
<h2>Running the client<a class="headerlink" href="#running-the-client" title="Permalink to this headline">¶</a></h2>
<p>We recommend you to test your code before running the client. For example, you can simply test <em>train.py</em> and <em>validate.py</em> by:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">train</span><span class="o">.</span><span class="n">py</span> <span class="o">../</span><span class="n">initial_model</span><span class="o">/</span><span class="n">initial_model</span><span class="o">.</span><span class="n">npz</span>
</pre></div>
</div>
<p>Once everything works as expected you can start the Reducer, upload the tar.gz compute package and the initial weights, followed by starting one or many combiners.
Finally connect a client to the network. Instructions for how to connect clients can be found in the <a class="reference external" href="https://github.com/scaleoutsystems/examples">examples</a>.</p>
</section>
</section>


          </div>
          <div class="page-nav">
            <div class="inner"><ul class="page-nav">
  <li class="prev">
    <a href="deployment.html"
       title="previous chapter">← Deployment</a>
  </li>
  <li class="next">
    <a href="releasenotes.html"
       title="next chapter">Release Notes →</a>
  </li>
</ul><div class="footer" role="contentinfo">
      &#169; Copyright 2021, Scaleout Systems AB.
    <br>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0 with <a href="https://github.com/schettino72/sphinx_press_theme">Press Theme</a> 0.8.0.
</div>
            </div>
          </div>
      </page>
    </div></div>
    
    
  </body>
</html>
<!DOCTYPE html>
<html >
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
      <title>fedn.clients.reducer.restservice</title>
    
          <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
          <link rel="stylesheet" href="../../../../_static/theme.css " type="text/css" />
          <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
      
      <!-- sphinx script_files -->
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>

      
      <!-- bundled in js (rollup iife) -->
      <!-- <script src="../../../../_static/theme-vendors.js"></script> -->
      <script src="../../../../_static/theme.js" defer></script>
    
  <link rel="index" title="Index" href="../../../../genindex.html" />
  <link rel="search" title="Search" href="../../../../search.html" /> 
  </head>

  <body>
    <div id="app">
    <div class="theme-container" :class="pageClasses"><navbar @toggle-sidebar="toggleSidebar">
  <router-link to="../../../../index.html" class="home-link">
    
      <img class="logo" src="../../../../_static/fedn_logo.webp" alt="logo"/>
    
  </router-link>

  <div class="links">
    <navlinks class="can-hide">



    </navlinks>
  </div>
</navbar>

      
      <div class="sidebar-mask" @click="toggleSidebar(false)">
      </div>
        <sidebar @toggle-sidebar="toggleSidebar">
          
          <navlinks>
            



            
          </navlinks><div id="searchbox" class="searchbox" role="search">
  <div class="caption"><span class="caption-text">Quick search</span>
    <div class="searchformwrapper">
      <form class="search" action="../../../../search.html" method="get">
        <input type="text" name="q" />
        <input type="submit" value="Search" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div><div class="sidebar-links" role="navigation" aria-label="main navigation">
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../../../../index.html#welcome-to-fedn">Contents:</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 ">
            
              <a href="../../../../readme.html" class="reference internal ">Welcome to FEDnâ€™s documentation</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../../../architecture.html" class="reference internal ">Architecture overview</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../../../deployment.html" class="reference internal ">Distributed deployment</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../../../tutorial.html" class="reference internal ">Creating a new federated model for use with FEDn</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../../../releasenotes.html" class="reference internal ">Release Notes</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../../../sdk.html" class="reference internal ">SDK Documentation</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../../../faq.html" class="reference internal ">Frequently asked questions</a>
            

            
          </li>

        
      </ul>
    </div>
  
</div>
        </sidebar>

      <page>
          <div class="body-header" role="navigation" aria-label="navigation">
  
  <ul class="breadcrumbs">
    <li><a href="../../../../index.html">Docs</a> &raquo;</li>
    
      <li><a href="../../../index.html">Module code</a> &raquo;</li>
    
    <li>fedn.clients.reducer.restservice</li>
  </ul>
  

  <ul class="page-nav">
</ul>
  
</div>
<hr>
          <div class="content" role="main" v-pre>
            
  <h1>Source code for fedn.clients.reducer.restservice</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">fedn.clients.reducer.interfaces</span> <span class="kn">import</span> <span class="n">CombinerInterface</span>
<span class="kn">from</span> <span class="nn">fedn.clients.reducer.state</span> <span class="kn">import</span> <span class="n">ReducerState</span><span class="p">,</span> <span class="n">ReducerStateToString</span>
<span class="kn">from</span> <span class="nn">flask_wtf.csrf</span> <span class="kn">import</span> <span class="n">CSRFProtect</span>
<span class="kn">from</span> <span class="nn">werkzeug.utils</span> <span class="kn">import</span> <span class="n">secure_filename</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">flash</span>

<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Lock</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">plotly</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
<span class="kn">import</span> <span class="nn">geoip2.database</span>
<span class="kn">from</span> <span class="nn">fedn.clients.reducer.plots</span> <span class="kn">import</span> <span class="n">Plot</span>

<span class="n">UPLOAD_FOLDER</span> <span class="o">=</span> <span class="s1">&#39;/app/client/package/&#39;</span>
<span class="n">ALLOWED_EXTENSIONS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;gz&#39;</span><span class="p">,</span> <span class="s1">&#39;bz2&#39;</span><span class="p">,</span> <span class="s1">&#39;tar&#39;</span><span class="p">,</span> <span class="s1">&#39;zip&#39;</span><span class="p">,</span> <span class="s1">&#39;tgz&#39;</span><span class="p">}</span>


<div class="viewcode-block" id="allowed_file"><a class="viewcode-back" href="../../../../fedn.clients.reducer.html#fedn.clients.reducer.restservice.allowed_file">[docs]</a><span class="k">def</span> <span class="nf">allowed_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    :param filename:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">filename</span> <span class="ow">and</span> \
           <span class="n">filename</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">ALLOWED_EXTENSIONS</span></div>


<div class="viewcode-block" id="ReducerRestService"><a class="viewcode-back" href="../../../../fedn.clients.reducer.html#fedn.clients.reducer.restservice.ReducerRestService">[docs]</a><span class="k">class</span> <span class="nc">ReducerRestService</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">certificate_manager</span><span class="p">,</span> <span class="n">certificate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;config object!: </span><span class="se">\n\n\n\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;discover_host&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;discover_host&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;discover_port&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_id</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-network&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]:</span>
            <span class="kn">import</span> <span class="nn">uuid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">control</span> <span class="o">=</span> <span class="n">control</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">certificate</span> <span class="o">=</span> <span class="n">certificate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">certificate_manager</span> <span class="o">=</span> <span class="n">certificate_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_compute_context</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># self.control.get_compute_context()</span>

<div class="viewcode-block" id="ReducerRestService.to_dict"><a class="viewcode-back" href="../../../../fedn.clients.reducer.html#fedn.clients.reducer.restservice.ReducerRestService.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="ReducerRestService.check_configured"><a class="viewcode-back" href="../../../../fedn.clients.reducer.html#fedn.clients.reducer.restservice.ReducerRestService.check_configured">[docs]</a>    <span class="k">def</span> <span class="nf">check_configured</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">get_compute_context</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;setup.html&#39;</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">ReducerStateToString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">state</span><span class="p">()),</span>
                                   <span class="n">logs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">message</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">state</span><span class="p">()</span> <span class="o">==</span> <span class="n">ReducerState</span><span class="o">.</span><span class="n">setup</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;setup.html&#39;</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">ReducerStateToString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">state</span><span class="p">()),</span>
                                   <span class="n">logs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Warning. Reducer is not base-configured. please do so with config file.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">get_latest_model</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;setup_model.html&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Please set the initial model.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="ReducerRestService.run"><a class="viewcode-back" href="../../../../fedn.clients.reducer.html#fedn.clients.reducer.restservice.ReducerRestService.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;UPLOAD_FOLDER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">UPLOAD_FOLDER</span>
        <span class="n">csrf</span> <span class="o">=</span> <span class="n">CSRFProtect</span><span class="p">()</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
        <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SECRET_KEY</span>
        <span class="n">csrf</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            :return:</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">not_configured</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_configured</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">not_configured</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">not_configured</span>
            <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">get_events</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">message_type</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message_type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;events.html&#39;</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">ReducerStateToString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">state</span><span class="p">()),</span>
                                   <span class="n">events</span><span class="o">=</span><span class="n">events</span><span class="p">,</span>
                                   <span class="n">logs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">configured</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span> <span class="n">message_type</span><span class="o">=</span><span class="n">message_type</span><span class="p">)</span>

        <span class="c1"># http://localhost:8090/add?name=combiner&amp;address=combiner&amp;port=12080&amp;token=e9a3cb4c5eaff546eec33ff68a7fbe232b68a192</span>
        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/status&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">status</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            :return:</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">ReducerStateToString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">state</span><span class="p">())}</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/netgraph&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">netgraph</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            :return:</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;nodes&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;edges&#39;</span><span class="p">:</span> <span class="p">[]}</span>

            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;r0&quot;</span><span class="p">,</span>
                <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Reducer&quot;</span><span class="p">,</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.2</span><span class="p">,</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s1">&#39;reducer&#39;</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">combiner_info</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">combiner</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">get_combiners</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">report</span> <span class="o">=</span> <span class="n">combiner</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
                    <span class="n">combiner_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="mf">0.5</span>
            <span class="n">width</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">combiner_info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="n">step</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">combiner_info</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">width</span> <span class="o">/</span> <span class="mf">3.0</span>
            <span class="k">for</span> <span class="n">combiner</span> <span class="ow">in</span> <span class="n">combiner_info</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;combiner info </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">combiner_info</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">combiner</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>  <span class="c1"># &quot;n{}&quot;.format(count),</span>
                        <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Combiner (</span><span class="si">{}</span><span class="s2"> clients)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">combiner</span><span class="p">[</span><span class="s1">&#39;nr_active_clients&#39;</span><span class="p">]),</span>
                        <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
                        <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span>
                        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">combiner</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s1">&#39;combiner&#39;</span><span class="p">,</span>
                        <span class="c1"># &quot;color&quot;:&#39;blue&#39;,</span>
                    <span class="p">})</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">step</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="mf">0.25</span>

            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">width</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">step</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">combiner_info</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">width</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="c1"># for combiner in self.control.statestore.list_clients():</span>
            <span class="k">for</span> <span class="n">combiner</span> <span class="ow">in</span> <span class="n">combiner_info</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">combiner</span><span class="p">[</span><span class="s1">&#39;nr_active_clients&#39;</span><span class="p">])):</span>
                    <span class="c1"># y = y + 0.25</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;c</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">count</span><span class="p">),</span>
                            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Client&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
                            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span>
                            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;c</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">count</span><span class="p">),</span>
                            <span class="s2">&quot;combiner&quot;</span><span class="p">:</span> <span class="n">combiner</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s1">&#39;client&#39;</span><span class="p">,</span>
                            <span class="c1"># &quot;color&quot;:&#39;blue&#39;,</span>
                        <span class="p">})</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                    <span class="c1"># print(&quot;combiner prefferred name {}&quot;.format(client[&#39;combiner&#39;]), flush=True)</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">0.25</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;combiner&#39;</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;e</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">count</span><span class="p">),</span>
                                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                                <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="s1">&#39;r0&#39;</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;client&#39;</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;e</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">count</span><span class="p">),</span>
                                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;combiner&#39;</span><span class="p">],</span>
                                <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="k">return</span> <span class="n">result</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/events&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">events</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            :return:</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="kn">import</span> <span class="nn">json</span>
            <span class="kn">from</span> <span class="nn">bson</span> <span class="kn">import</span> <span class="n">json_util</span>

            <span class="n">json_docs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">get_events</span><span class="p">():</span>
                <span class="n">json_doc</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">json_util</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
                <span class="n">json_docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json_doc</span><span class="p">)</span>

            <span class="n">json_docs</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;events&#39;</span><span class="p">:</span> <span class="n">json_docs</span><span class="p">}</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/add&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">add</span><span class="p">():</span>

            <span class="sd">&quot;&quot;&quot; Add a combiner to the network. &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">state</span><span class="p">()</span> <span class="o">==</span> <span class="n">ReducerState</span><span class="o">.</span><span class="n">setup</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;retry&#39;</span><span class="p">})</span>

            <span class="c1"># TODO check for get variables</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">address</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;address&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># token = request.args.get(&#39;token&#39;)</span>
            <span class="c1"># TODO do validation</span>

            <span class="k">if</span> <span class="n">port</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">address</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Please specify correct parameters.&quot;</span>

            <span class="c1"># Try to retrieve combiner from db</span>
            <span class="n">combiner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">get_combiner</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">combiner</span><span class="p">:</span>
                <span class="c1"># Create a new combiner</span>
                <span class="kn">import</span> <span class="nn">base64</span>
                <span class="n">certificate</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">certificate_manager</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">address</span><span class="p">)</span><span class="o">.</span><span class="n">get_keypair_raw</span><span class="p">()</span>
                <span class="n">cert_b64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">certificate</span><span class="p">)</span>
                <span class="n">key_b64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

                <span class="c1"># TODO append and redirect to index.</span>
                <span class="kn">import</span> <span class="nn">copy</span>
                <span class="n">combiner</span> <span class="o">=</span> <span class="n">CombinerInterface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">certificate</span><span class="p">),</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
                                             <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">add_combiner</span><span class="p">(</span><span class="n">combiner</span><span class="p">)</span>

            <span class="n">combiner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">get_combiner</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;added&#39;</span><span class="p">,</span>
                <span class="s1">&#39;certificate&#39;</span><span class="p">:</span> <span class="n">combiner</span><span class="p">[</span><span class="s1">&#39;certificate&#39;</span><span class="p">],</span>
                <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">combiner</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">],</span>
                <span class="s1">&#39;storage&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">statestore</span><span class="o">.</span><span class="n">get_storage_backend</span><span class="p">(),</span>
                <span class="s1">&#39;statestore&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">statestore</span><span class="o">.</span><span class="n">get_config</span><span class="p">(),</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/eula&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">eula</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            :return:</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;header contains: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;eula.html&#39;</span><span class="p">,</span> <span class="n">configured</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/models&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">models</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            :return:</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
                <span class="c1"># upload seed file</span>
                <span class="n">uploaded_seed</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">uploaded_seed</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">uploaded_seed</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">uploaded_seed</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                    <span class="n">helper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">get_helper</span><span class="p">()</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">load_model_from_BytesIO</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">getbuffer</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">uploaded_seed</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">not_configured</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_configured</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">not_configured</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">not_configured</span>
                <span class="n">h_latest_model_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">get_latest_model</span><span class="p">()</span>

                <span class="n">model_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;models.html&#39;</span><span class="p">,</span> <span class="n">h_latest_model_id</span><span class="o">=</span><span class="n">h_latest_model_id</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">model_info</span><span class="o">=</span><span class="n">model_info</span><span class="p">,</span> <span class="n">configured</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">seed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">))</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/delete_model_trail&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">delete_model_trail</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            :return:</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">fedn.common.tracer.mongotracer</span> <span class="kn">import</span> <span class="n">MongoTracer</span>
                <span class="n">statestore_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">statestore</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tracer</span> <span class="o">=</span> <span class="n">MongoTracer</span><span class="p">(</span><span class="n">statestore_config</span><span class="p">[</span><span class="s1">&#39;mongo_config&#39;</span><span class="p">],</span> <span class="n">statestore_config</span><span class="p">[</span><span class="s1">&#39;network_id&#39;</span><span class="p">])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">drop_models</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="c1"># drop objects in minio</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">delete_bucket_objects</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;models&#39;</span><span class="p">))</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">))</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/drop_control&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">drop_control</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            :return:</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">statestore</span><span class="o">.</span><span class="n">drop_control</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;control&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;control&#39;</span><span class="p">))</span>

        <span class="c1"># http://localhost:8090/control?rounds=4&amp;model_id=879fa112-c861-4cb1-a25d-775153e5b548</span>
        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/control&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">control</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot; Main page for round control. Configure, start and stop global training rounds. &quot;&quot;&quot;</span>

            <span class="n">not_configured</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_configured</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">not_configured</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">not_configured</span>
            <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">ReducerStateToString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">state</span><span class="p">())</span>
            <span class="n">logs</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">refresh</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_compute_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">get_compute_context</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_compute_context</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_compute_context</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_compute_context</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;setup.html&#39;</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="n">logs</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                       <span class="n">message</span><span class="o">=</span><span class="s1">&#39;No compute context is set. Please set one here &lt;a href=&quot;/context&quot;&gt;/context&lt;/a&gt;&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">state</span><span class="p">()</span> <span class="o">==</span> <span class="n">ReducerState</span><span class="o">.</span><span class="n">setup</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;setup.html&#39;</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="n">logs</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="n">refresh</span><span class="p">,</span>
                                       <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Warning. Reducer is not base-configured. please do so with config file.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">state</span><span class="p">()</span> <span class="o">==</span> <span class="n">ReducerState</span><span class="o">.</span><span class="n">monitoring</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span>
                    <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="n">refresh</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Reducer is in monitoring state&quot;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
                <span class="n">timeout</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timeout&#39;</span><span class="p">,</span> <span class="mi">180</span><span class="p">))</span>
                <span class="n">rounds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rounds&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">task</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;task&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                <span class="n">clients_required</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;clients_required&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">clients_requested</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;clients_requested&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

                <span class="c1"># checking if there are enough clients connected to start!</span>
                <span class="n">clients_available</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">combiner</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">get_combiners</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">combiner</span><span class="o">.</span><span class="n">allowing_clients</span><span class="p">():</span>
                            <span class="n">combiner_state</span> <span class="o">=</span> <span class="n">combiner</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
                            <span class="n">nac</span> <span class="o">=</span> <span class="n">combiner_state</span><span class="p">[</span><span class="s1">&#39;nr_active_clients&#39;</span><span class="p">]</span>

                            <span class="n">clients_available</span> <span class="o">=</span> <span class="n">clients_available</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">nac</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="k">if</span> <span class="n">clients_available</span> <span class="o">&lt;</span> <span class="n">clients_required</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
                                            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Not enough clients available to start rounds! &quot;</span>
                                                    <span class="s2">&quot;check combiner client capacity&quot;</span><span class="p">,</span>
                                            <span class="n">message_type</span><span class="o">=</span><span class="s1">&#39;warning&#39;</span><span class="p">))</span>

                <span class="n">validate</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;validate&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">validate</span> <span class="o">==</span> <span class="s1">&#39;False&#39;</span><span class="p">:</span>
                    <span class="n">validate</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">helper_type</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;helper&#39;</span><span class="p">,</span> <span class="s1">&#39;keras&#39;</span><span class="p">)</span>
                <span class="c1"># self.control.statestore.set_framework(helper_type)</span>

                <span class="n">latest_model_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">get_latest_model</span><span class="p">()</span>

                <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;round_timeout&#39;</span><span class="p">:</span> <span class="n">timeout</span><span class="p">,</span> <span class="s1">&#39;model_id&#39;</span><span class="p">:</span> <span class="n">latest_model_id</span><span class="p">,</span>
                          <span class="s1">&#39;rounds&#39;</span><span class="p">:</span> <span class="n">rounds</span><span class="p">,</span> <span class="s1">&#39;clients_required&#39;</span><span class="p">:</span> <span class="n">clients_required</span><span class="p">,</span>
                          <span class="s1">&#39;clients_requested&#39;</span><span class="p">:</span> <span class="n">clients_requested</span><span class="p">,</span> <span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">task</span><span class="p">,</span>
                          <span class="s1">&#39;validate&#39;</span><span class="p">:</span> <span class="n">validate</span><span class="p">,</span> <span class="s1">&#39;helper_type&#39;</span><span class="p">:</span> <span class="n">helper_type</span><span class="p">}</span>

                <span class="kn">import</span> <span class="nn">threading</span>
                <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">instruct</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">config</span><span class="p">,))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="c1"># self.control.instruct(config)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="n">refresh</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Sent execution plan.&quot;</span><span class="p">,</span>
                                        <span class="n">message_type</span><span class="o">=</span><span class="s1">&#39;SUCCESS&#39;</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">seed_model_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">latest_model_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">seed_model_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">get_first_model</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">latest_model_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">get_latest_model</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">latest_model_id</span><span class="o">=</span><span class="n">latest_model_id</span><span class="p">,</span>
                                       <span class="n">compute_package</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_compute_context</span><span class="p">,</span>
                                       <span class="n">seed_model_id</span><span class="o">=</span><span class="n">seed_model_id</span><span class="p">,</span>
                                       <span class="n">helper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">statestore</span><span class="o">.</span><span class="n">get_framework</span><span class="p">(),</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">configured</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">ReducerStateToString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">state</span><span class="p">())</span>
            <span class="n">logs</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">refresh</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="n">logs</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="n">refresh</span><span class="p">,</span>
                                   <span class="n">configured</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/assign&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">assign</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;Handle client assignment requests. &quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">state</span><span class="p">()</span> <span class="o">==</span> <span class="n">ReducerState</span><span class="o">.</span><span class="n">setup</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;retry&#39;</span><span class="p">})</span>

            <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">combiner_preferred</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;combiner&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">combiner_preferred</span><span class="p">:</span>
                <span class="n">combiner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">combiner_preferred</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">combiner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">find_available_combiner</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">combiner</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;retry&#39;</span><span class="p">})</span>
            <span class="c1">## Check that a framework has been selected prior to assigning clients.</span>
            <span class="n">framework</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">statestore</span><span class="o">.</span><span class="n">get_framework</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">framework</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;retry&#39;</span><span class="p">})</span>

            <span class="n">client</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;combiner_preferred&#39;</span><span class="p">:</span> <span class="n">combiner_preferred</span><span class="p">,</span>
                <span class="s1">&#39;combiner&#39;</span><span class="p">:</span> <span class="n">combiner</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;ip&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">,</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;available&#39;</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">add_client</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">combiner</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">base64</span>
                <span class="n">cert_b64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">combiner</span><span class="o">.</span><span class="n">certificate</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;assigned&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">combiner</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
                    <span class="s1">&#39;ip&#39;</span><span class="p">:</span> <span class="n">combiner</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span>
                    <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">combiner</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
                    <span class="s1">&#39;certificate&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">cert_b64</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s1">&#39;model_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">statestore</span><span class="o">.</span><span class="n">get_framework</span><span class="p">()</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">combiner</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;retry&#39;</span><span class="p">})</span>

            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;retry&#39;</span><span class="p">})</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/infer&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">infer</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            :return:</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">state</span><span class="p">()</span> <span class="o">==</span> <span class="n">ReducerState</span><span class="o">.</span><span class="n">setup</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Error, not configured&quot;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">set_model_id</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">fedn</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ModelError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to seed control.&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">result</span>

        <span class="k">def</span> <span class="nf">combiner_status</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot; Get current status reports from all combiners registered in the network. </span>

<span class="sd">            :return:</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">combiner_info</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">combiner</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">get_combiners</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">report</span> <span class="o">=</span> <span class="n">combiner</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
                    <span class="n">combiner_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">return</span> <span class="n">combiner_info</span>

        <span class="k">def</span> <span class="nf">client_status</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get current status of clients (available) from DB compared with client status from all combiners,</span>
<span class="sd">            update client status to DB and add their roles.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">client_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">get_client_info</span><span class="p">()</span>
            <span class="n">combiner_info</span> <span class="o">=</span> <span class="n">combiner_status</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">all_active_trainers</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">all_active_validators</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">client</span> <span class="ow">in</span> <span class="n">combiner_info</span><span class="p">:</span>
                    <span class="n">active_trainers_str</span> <span class="o">=</span> <span class="n">client</span><span class="p">[</span><span class="s1">&#39;active_trainers&#39;</span><span class="p">]</span>
                    <span class="n">active_validators_str</span> <span class="o">=</span> <span class="n">client</span><span class="p">[</span><span class="s1">&#39;active_validators&#39;</span><span class="p">]</span>
                    <span class="n">active_trainers_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[^a-zA-Z0-9:</span><span class="se">\n</span><span class="s1">\.]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">active_trainers_str</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;name:&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
                    <span class="n">active_validators_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[^a-zA-Z0-9:</span><span class="se">\n</span><span class="s1">\.]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">active_validators_str</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;name:&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
                    <span class="n">all_active_trainers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">active_trainers_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
                    <span class="n">all_active_validators</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">active_validators_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

                <span class="n">active_trainers_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">client</span> <span class="k">for</span> <span class="n">client</span> <span class="ow">in</span> <span class="n">client_info</span> <span class="k">if</span> <span class="n">client</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">all_active_trainers</span><span class="p">]</span>
                <span class="n">active_validators_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cl</span> <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">client_info</span> <span class="k">if</span> <span class="n">cl</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">all_active_validators</span><span class="p">]</span>
                <span class="n">all_clients</span> <span class="o">=</span> <span class="p">[</span><span class="n">cl</span> <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">client_info</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">client</span> <span class="ow">in</span> <span class="n">all_clients</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;offline&#39;</span>
                    <span class="n">role</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">update_client_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">role</span><span class="p">)</span>

                <span class="n">all_active_clients</span> <span class="o">=</span> <span class="n">active_validators_list</span> <span class="o">+</span> <span class="n">active_trainers_list</span>
                <span class="k">for</span> <span class="n">client</span> <span class="ow">in</span> <span class="n">all_active_clients</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;active&#39;</span>
                    <span class="k">if</span> <span class="n">client</span> <span class="ow">in</span> <span class="n">active_trainers_list</span> <span class="ow">and</span> <span class="n">client</span> <span class="ow">in</span> <span class="n">active_validators_list</span><span class="p">:</span>
                        <span class="n">role</span> <span class="o">=</span> <span class="s1">&#39;trainer-validator&#39;</span>
                    <span class="k">elif</span> <span class="n">client</span> <span class="ow">in</span> <span class="n">active_trainers_list</span><span class="p">:</span>
                        <span class="n">role</span> <span class="o">=</span> <span class="s1">&#39;trainer&#39;</span>
                    <span class="k">elif</span> <span class="n">client</span> <span class="ow">in</span> <span class="n">active_validators_list</span><span class="p">:</span>
                        <span class="n">role</span> <span class="o">=</span> <span class="s1">&#39;validator&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">role</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">update_client_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">role</span><span class="p">)</span>

                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;active_clients&#39;</span><span class="p">:</span> <span class="n">all_clients</span><span class="p">,</span>
                        <span class="s1">&#39;active_trainers&#39;</span><span class="p">:</span> <span class="n">active_trainers_list</span><span class="p">,</span>
                        <span class="s1">&#39;active_validators&#39;</span><span class="p">:</span> <span class="n">active_validators_list</span>
                        <span class="p">}</span>
            <span class="k">except</span><span class="p">:</span>
                 <span class="k">pass</span>

            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;active_clients&#39;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s1">&#39;active_trainers&#39;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s1">&#39;active_validators&#39;</span><span class="p">:</span> <span class="p">[]</span>
                    <span class="p">}</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/metric_type&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">change_features</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            :return:</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">feature</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">]</span>
            <span class="n">plot</span> <span class="o">=</span> <span class="n">Plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">statestore</span><span class="p">)</span>
            <span class="n">graphJSON</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">create_box_plot</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">graphJSON</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/dashboard&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">dashboard</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            :return:</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">not_configured</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_configured</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">not_configured</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">not_configured</span>

            <span class="n">plot</span> <span class="o">=</span> <span class="n">Plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">statestore</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">valid_metrics</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">fetch_valid_metrics</span><span class="p">()</span>
                <span class="n">box_plot</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">create_box_plot</span><span class="p">(</span><span class="n">valid_metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">valid_metrics</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">box_plot</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">table_plot</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">create_table_plot</span><span class="p">()</span>
            <span class="c1"># timeline_plot = plot.create_timeline_plot()</span>
            <span class="n">timeline_plot</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">clients_plot</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">create_client_plot</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;dashboard.html&#39;</span><span class="p">,</span> <span class="n">show_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">box_plot</span><span class="o">=</span><span class="n">box_plot</span><span class="p">,</span>
                                   <span class="n">table_plot</span><span class="o">=</span><span class="n">table_plot</span><span class="p">,</span>
                                   <span class="n">timeline_plot</span><span class="o">=</span><span class="n">timeline_plot</span><span class="p">,</span>
                                   <span class="n">clients_plot</span><span class="o">=</span><span class="n">clients_plot</span><span class="p">,</span>
                                   <span class="n">metrics</span><span class="o">=</span><span class="n">valid_metrics</span><span class="p">,</span>
                                   <span class="n">configured</span><span class="o">=</span><span class="kc">True</span>
                                   <span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/network&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">network</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            :return:</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">not_configured</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_configured</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">not_configured</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">not_configured</span>
            <span class="n">plot</span> <span class="o">=</span> <span class="n">Plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">statestore</span><span class="p">)</span>
            <span class="n">round_time_plot</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">create_round_plot</span><span class="p">()</span>
            <span class="n">mem_cpu_plot</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">create_cpu_plot</span><span class="p">()</span>
            <span class="n">combiners_plot</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">create_combiner_plot</span><span class="p">()</span>
            <span class="n">combiner_info</span> <span class="o">=</span> <span class="n">combiner_status</span><span class="p">()</span>
            <span class="n">active_clients</span> <span class="o">=</span> <span class="n">client_status</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;network.html&#39;</span><span class="p">,</span> <span class="n">network_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">round_time_plot</span><span class="o">=</span><span class="n">round_time_plot</span><span class="p">,</span>
                                   <span class="n">mem_cpu_plot</span><span class="o">=</span><span class="n">mem_cpu_plot</span><span class="p">,</span>
                                   <span class="n">combiners_plot</span><span class="o">=</span><span class="n">combiners_plot</span><span class="p">,</span>
                                   <span class="n">combiner_info</span><span class="o">=</span><span class="n">combiner_info</span><span class="p">,</span>
                                   <span class="n">active_clients</span><span class="o">=</span><span class="n">active_clients</span><span class="p">[</span><span class="s1">&#39;active_clients&#39;</span><span class="p">],</span>
                                   <span class="n">active_trainers</span><span class="o">=</span><span class="n">active_clients</span><span class="p">[</span><span class="s1">&#39;active_trainers&#39;</span><span class="p">],</span>
                                   <span class="n">active_validators</span><span class="o">=</span><span class="n">active_clients</span><span class="p">[</span><span class="s1">&#39;active_validators&#39;</span><span class="p">],</span>
                                   <span class="n">configured</span><span class="o">=</span><span class="kc">True</span>
                                   <span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/config/download&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">config_download</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            :return:</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">chk_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">get_compute_context</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">chk_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">UPLOAD_FOLDER</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;trying to get </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
                <span class="kn">from</span> <span class="nn">fedn.utils.checksum</span> <span class="kn">import</span> <span class="n">md5</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">sum</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">md5</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">sum</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">chk_string</span> <span class="o">=</span> <span class="s2">&quot;checksum: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span>

            <span class="n">network_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_id</span>
            <span class="n">discover_host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="n">discover_port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;network_id: </span><span class="si">{network_id}</span><span class="s2"></span>
<span class="s2">controller:</span>
<span class="s2">    discover_host: </span><span class="si">{discover_host}</span><span class="s2"></span>
<span class="s2">    discover_port: </span><span class="si">{discover_port}</span><span class="s2"></span>
<span class="s2">    token: </span><span class="si">{token}</span><span class="s2"></span>
<span class="s2">    </span><span class="si">{chk_string}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">network_id</span><span class="o">=</span><span class="n">network_id</span><span class="p">,</span>
                           <span class="n">discover_host</span><span class="o">=</span><span class="n">discover_host</span><span class="p">,</span>
                           <span class="n">discover_port</span><span class="o">=</span><span class="n">discover_port</span><span class="p">,</span>
                           <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span>
                           <span class="n">chk_string</span><span class="o">=</span><span class="n">chk_string</span><span class="p">)</span>

            <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
            <span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">send_file</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">))</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span>
                             <span class="n">as_attachment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">attachment_filename</span><span class="o">=</span><span class="s1">&#39;client.yaml&#39;</span><span class="p">,</span>
                             <span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;application/x-yaml&#39;</span><span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/context&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
        <span class="nd">@csrf</span><span class="o">.</span><span class="n">exempt</span>  <span class="c1"># TODO fix csrf token to form posting in package.py</span>
        <span class="k">def</span> <span class="nf">context</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            :return:</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># if self.control.state() != ReducerState.setup or self.control.state() != ReducerState.idle:</span>
            <span class="c1">#    return &quot;Error, Context already assigned!&quot;</span>
            <span class="n">reset</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reset&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># if reset is not empty then allow context re-set</span>
            <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;context.html&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>

                <span class="k">if</span> <span class="s1">&#39;file&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
                    <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;No file part&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">))</span>

                <span class="n">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>
                <span class="n">helper_type</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;helper&#39;</span><span class="p">,</span> <span class="s1">&#39;keras&#39;</span><span class="p">)</span>
                <span class="c1"># if user does not select file, browser also</span>
                <span class="c1"># submit an empty part without filename</span>
                <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;No selected file&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">file</span> <span class="ow">and</span> <span class="n">allowed_file</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;UPLOAD_FOLDER&#39;</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">state</span><span class="p">()</span> <span class="o">==</span> <span class="n">ReducerState</span><span class="o">.</span><span class="n">instructing</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">state</span><span class="p">()</span> <span class="o">==</span> <span class="n">ReducerState</span><span class="o">.</span><span class="n">monitoring</span><span class="p">:</span>
                        <span class="k">return</span> <span class="s2">&quot;Not allowed to change context while execution is ongoing.&quot;</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">set_compute_context</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">statestore</span><span class="o">.</span><span class="n">set_framework</span><span class="p">(</span><span class="n">helper_type</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;control&#39;</span><span class="p">))</span>

            <span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">send_from_directory</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">get_compute_context</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;context.html&#39;</span><span class="p">)</span>

            <span class="c1"># There is a potential race condition here, if one client requests a package and at</span>
            <span class="c1"># the same time another one triggers a fetch from Minio and writes to disk. </span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mutex</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
                <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">send_from_directory</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;UPLOAD_FOLDER&#39;</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="n">as_attachment</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">get_compute_package</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;UPLOAD_FOLDER&#39;</span><span class="p">],</span> <span class="n">name</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">send_from_directory</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;UPLOAD_FOLDER&#39;</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="n">as_attachment</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;context.html&#39;</span><span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/checksum&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">checksum</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            :return:</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># sum = &#39;&#39;</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">get_compute_context</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({})</span>

            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">UPLOAD_FOLDER</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;trying to get </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
            <span class="kn">from</span> <span class="nn">fedn.utils.checksum</span> <span class="kn">import</span> <span class="n">md5</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="nb">sum</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">md5</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">sum</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;checksum&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">}</span>
            <span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">jsonify</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">certificate</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;trying to connect with certs </span><span class="si">{}</span><span class="s2"> and key </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">certificate</span><span class="o">.</span><span class="n">cert_path</span><span class="p">),</span>
                                                                      <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">certificate</span><span class="o">.</span><span class="n">key_path</span><span class="p">)),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
                    <span class="n">ssl_context</span><span class="o">=</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">certificate</span><span class="o">.</span><span class="n">cert_path</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">certificate</span><span class="o">.</span><span class="n">key_path</span><span class="p">)))</span></div></div>
</pre></div>

          </div>
          <div class="page-nav">
            <div class="inner"><ul class="page-nav">
</ul><div class="footer" role="contentinfo">
      &#169; Copyright 2021, Scaleout Systems AB.
    <br>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.2.0 with <a href="https://github.com/schettino72/sphinx_press_theme">Press Theme</a> 0.8.0.
</div>
            </div>
          </div>
      </page>
    </div></div>
    
    
  </body>
</html>